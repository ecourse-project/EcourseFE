import _slicedToArray from "@babel/runtime/helpers/esm/slicedToArray";
import isEqual from 'fast-deep-equal';
import { memo, useEffect } from 'react';
import { storeApiSetState } from 'zustand-utils';
import { shallow } from 'zustand/shallow';
import { useProBuilder } from "../../hooks/useProBuilder";
import { useStore, useStoreApi } from "../../store";
var AssetStoreUpdater = /*#__PURE__*/memo(function () {
  var instance = useProBuilder();
  var _useStore = useStore(function (s) {
      return [s.componentAsset.componentStoreApi, s.componentAsset.configSelector, s.componentAsset.setConfig, s.config];
    }, shallow),
    _useStore2 = _slicedToArray(_useStore, 4),
    useAssetStoreApi = _useStore2[0],
    configSelector = _useStore2[1],
    setConfig = _useStore2[2],
    config = _useStore2[3];
  var assetStoreApi = useAssetStoreApi();
  useEffect(function () {
    storeApiSetState(assetStoreApi, instance, false, {
      type: 'â¬ æ³¨å…¥ editor æ–¹æ³•',
      payload: Object.keys(instance)
    });
  }, []);

  // å°†è®¡ç®—åçš„é»˜è®¤å€¼ä¼ ç»™é¢æ¿
  // ç”¨ç­‰å¼åšä¸€æ¬¡ä¼˜åŒ–ï¼Œä¸ç„¶æ¯æ¬¡éƒ½ä¼šé‡æ–°è®¡ç®—
  var defaultConfig = useStore(function (s) {
    var config;
    if (s.componentAsset.defaultConfig) {
      config = s.componentAsset.defaultConfig;
    } else {
      if (s.componentAsset.configSelector) {
        config = s.componentAsset.configSelector(s.componentAsset.getDefaultConfig(s.mode));
      } else {
        config = s.componentAsset.getDefaultConfig(s.mode);
      }
    }
    return config;
  }, isEqual);
  var proBuilderStoreApi = useStoreApi();

  // ç”¨ defaultConfig æ›´æ–° config
  useEffect(function () {
    if (!!config) return;
    var state = {
      config: defaultConfig
    };
    storeApiSetState(proBuilderStoreApi, state, false, {
      type: 'â¬ æ³¨å…¥åˆå§‹åŒ– config',
      payload: state
    });
    proBuilderStoreApi.getState().yjsDoc.updateHistoryData(state);
    setConfig(defaultConfig, function (state) {
      storeApiSetState(assetStoreApi, state, false, {
        type: 'ğŸ”„ åˆå§‹åŒ–çŠ¶æ€',
        payload: state
      });
    });
  }, [defaultConfig]);

  // å°† proBuilderStore çš„ config è‡ªåŠ¨åŒæ­¥åˆ°  assetStore
  useEffect(function () {
    if (!!config) {
      var assetConfig = configSelector(assetStoreApi.getState());
      if (isEqual(assetConfig, config)) return;
      setConfig(config, function (state) {
        storeApiSetState(assetStoreApi, state, false, {
          type: 'ğŸ”„ åŒæ­¥ Editor çŠ¶æ€',
          payload: state
        });
      });
    }
  }, [config]);
  return null;
});
export default AssetStoreUpdater;